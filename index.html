<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³ç¢‡è¨˜æ†¶ï¼šå±±åŸèˆ‡æºªæµçš„å–µå°è©±</title>
    <style>
        /* CSS æ¨£å¼ (ç¶­æŒåŸæ¨£) */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(rgba(10,10,10,0.7), rgba(25,50,50,0.6)), url('assets/bg.jpg') center/cover fixed no-repeat;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(30,30,30,0.85); 
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            padding: 40px;
            position: relative;
        }
        #outer-wrap {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
 
        h1 {
            color: #64b5f6;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #aaa;
            font-style: italic;
            margin-bottom: 30px;
            display: block;
        }

        h2 {
            color: #ffb74d;
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,183,77,0.3);
        }
        .screen {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            background-color: #ffb74d;
            color: #222;
            border: none;
            padding: 12px 30px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn:hover:not(.disabled) {
            background-color: #ffa726;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-secondary {
            background-color: transparent;
            border: 2px solid #aaa;
            color: #aaa;
        }
        .btn-secondary:hover:not(.disabled) {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
            border-color: #fff;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .story-box {
            padding: 20px;
            background-color: rgba(0,0,0,0.2);
            border-left: 4px solid #64b5f6;
            border-radius: 4px;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 1.05em;
        }

        #role-selection-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }
        .role-card {
            border: 2px solid rgba(255, 128, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            background-color: rgba(60,60,60,0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            color: #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .role-card-image {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #2a2a2a;
            border: 3px solid rgba(255,255,255,0.1);
        }
        .role-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .role-card-content {
            flex: 1;
        }
        .role-card:hover:not(.selected) {
            background-color: rgba(80,80,80,0.5);
            border-color: rgba(255, 128, 0, 0.6);
        }
        .role-card.selected {
            border-color: #ffb74d;
            background-color: rgba(255, 183, 77, 0.15);
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.3);
        }
        .role-card h3 {
            color: #ffb74d;
            margin: 0 0 8px 0;
            font-size: 1.2em;
        }
        .role-card p {
            margin: 4px 0;
            font-size: 0.9em;
            color: #ccc;
        }

        .question-box {
            background-color: rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        #question-text {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fff;
        }
        .options-list {
            list-style: none;
            padding: 0;
        }
        .options-list li {
            background-color: rgba(70,70,70,0.5);
            margin: 10px 0;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        .options-list li:hover:not(.disabled) {
            background-color: rgba(90,90,90,0.7);
            border-color: #64b5f6;
        }
        .options-list li.correct-answer { background-color: rgba(46, 125, 50, 0.6); border-color: #4caf50; color: #fff; }
        .options-list li.wrong-answer { background-color: rgba(198, 40, 40, 0.6); border-color: #f44336; color: #fff; opacity: 0.7; }
        
        .ability-box {
            background-color: rgba(255, 183, 77, 0.1);
            border: 1px solid rgba(255, 183, 77, 0.3);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ability-info {
            flex: 1;
        }
        .ability-btn {
            background-color: #ffb74d;
            color: #222;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            flex-shrink: 0;
            margin-left: 15px;
        }
        .ability-btn:hover:not(.disabled) { background-color: #ffa726; box-shadow: 0 4px 8px rgba(255, 167, 38, 0.4); }

        #message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            min-height: 20px;
        }
        .fragment { color: #ffb74d; font-weight: bold; }
        
        #player-role-display {
            background: linear-gradient(to right, rgba(40,40,40,0), rgba(100, 181, 246, 0.1));
            border-left: 4px solid #64b5f6;
            padding: 10px 15px;
            margin-bottom: 20px;
            color: #ccc;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .specialty-q-hint { font-size: 0.9em; color: #81c784; }

        #game-character-display {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 160px;
            height: auto;
            z-index: 100;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            transition: transform 0.3s ease;
        }
        #game-character-display:hover {
             transform: translateY(-5px) scale(1.05);
        }
        #game-character-display img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #next-q-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            body { padding: 10px; align-items: flex-start; }
            #game-container { padding: 25px 20px; margin-top: 20px; }
            #role-selection-grid { grid-template-columns: 1fr; gap: 15px; }
            .role-card-image { width: 80px; height: 80px; }
            .ability-box { flex-direction: column; text-align: left; align-items: flex-start; }
            .ability-btn { margin-left: 0; margin-top: 15px; width: 100%; }
            #game-character-display { width: 120px; bottom: 15px; left: 15px; opacity: 0.8; }
            #player-role-display { flex-direction: column; align-items: flex-start; gap: 5px; }
        }
    </style>
</head>
<body>
    <div id="outer-wrap">

    <div id="game-container">
        <header>
            <h1>
                <img id="site-logo" src="assets/logo.png" alt="çŸ³ç¢‡è¨˜æ†¶" style="max-width: 320px; width: 100%; height: auto; display: block; margin: 0 auto;">
            </h1>
            <span class="subtitle">â€” å°‹æ‰¾å±±åŸèˆ‡æºªæµå¤±è½çš„é€£çµ â€”</span>
        </header>

        <div id="start-screen" class="screen">
            <h2>ğŸ“œ å‰è¨€ï¼šè²“å’ªçš„å‘¼å–š</h2>
            <div class="story-box">
                <p>ä½ æ˜¯ä¸€ä½å°åœ°æ–¹æ–‡å²å……æ»¿å¥½å¥‡çš„è€ƒå¯Ÿè€…ã€‚</p>
                <p>æœ€è¿‘ï¼Œä½ æ”¶åˆ°äº†ä¸€ä»½ä¾†è‡ªæ–°åŒ—å¸‚çŸ³ç¢‡å€çš„ç¥ç§˜é‚€è«‹ã€‚ä¿¡ä¸Šèªªï¼Œæµç¶“å±±åŸçš„ã€Œæ–‡å±±æºªã€æœ€è¿‘è®Šå¾—æ²‰é»˜äº†ï¼Œéœ€è¦æœ‰äººä¾†è§£é–‹åœŸåœ°çš„è¨˜æ†¶å°å°ã€‚</p>
                <p>ç•¶ä½ ç«™åœ¨å¤è€çš„ã€Œä¸è¦‹å¤©è¡—ã€å£æ™‚ï¼Œå¹¾éš»çœ¼ç¥å……æ»¿éˆæ€§çš„<strong>è²“å’ª</strong>æ‚„æ‚„åœç¹è‘—ä½ ã€‚å‚³èªªä¸­ï¼Œç‰ å€‘æ˜¯å®ˆè­·é€™åº§å±±åŸè¨˜æ†¶çš„ç²¾éˆã€‚</p>
                <p>ç‚ºäº†è½æ‡‚å±±åŸçš„è²éŸ³ï¼Œä½ å¿…é ˆé¸æ“‡ä¸€ä½æœ€æŠ•ç·£çš„<strong>ã€Œåœ¨åœ°å–µå¤¥ä¼´ã€</strong>ï¼Œåœ¨ç‰ çš„å¸¶é ˜ä¸‹ï¼Œå±•é–‹ä¸€å ´ç©¿æ¢­é»‘é‡‘æ­²æœˆèˆ‡æ¸…æ¾ˆæºªæµçš„å†’éšªã€‚</p>
            </div>
            <div style="text-align: center;">
                <p><strong>è¡Œå‹•ç›®æ¨™ï¼š</strong> é¸æ“‡ä¸€å€‹åœ¨åœ°è²“å¤¥ä¼´å¹«åŠ©ä½ é€šéä¸‰é“é—œå¡ æ”¶é›†è¨˜æ†¶çš„ç¢ç‰‡!</p>
                <button class="btn" onclick="goToRoleSelection()">å‡ºç™¼å°‹æ‰¾å–µå¤¥ä¼´</button>
            </div>
        </div>

        <div id="select-role-screen" class="screen">
            <h2>ğŸ¾ é¸æ“‡ä½ çš„åœ¨åœ°å–µå¤¥ä¼´</h2>
            <p>è«‹é¸æ“‡ä¸€ä½èˆ‡ä½ çµä¼´åŒè¡Œçš„è²“å’ªï¼Œç‰ å€‘å„è‡ªä»£è¡¨äº†çŸ³ç¢‡ä¸åŒçš„æ–‡åŒ–è¨˜æ†¶ï¼š</p>
            
            <div id="role-selection-grid">
                </div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-secondary" onclick="history.back()">&laquo; è¿”å›æ¨™é¡Œ</button>
                <button class="btn disabled" id="confirm-role-btn" onclick="confirmRoleSelection()">èˆ‡ç‰ åŒè¡Œï¼Œé–‹å§‹æ—…ç¨‹ &raquo;</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="player-role-display">
                <span id="partner-info-text"></span>
                <span id="progress-text" style="font-weight: bold; color: #ffb74d;"></span>
            </div>

            <h2 id="stage-title">é—œå¡æ¨™é¡Œ</h2>
            
            <div id="question-area" class="question-box">
                <p id="question-text"></p>
                <ul id="options-list" class="options-list">
                    </ul>
                
                <div id="ability-ui" class="ability-box">
                    <div class="ability-info">
                        <strong>å–µå¤¥ä¼´æ”¯æ´ï¼š</strong> <span id="current-ability"></span>
                        <div style="font-size: 0.85em; margin-top: 5px; color: #aaa;">(æ³¨: å–µå¤¥ä¼´åªèƒ½åœ¨ç‰ ç†Ÿæ‚‰çš„é ˜åŸŸä¼¸å‡ºæ´æ‰‹ï¼Œæ¯é—œé™ç”¨ä¸€æ¬¡ã€‚)</div>
                    </div>
                    <button class="ability-btn" onclick="useAbility()">è«‹æ±‚è²“æŒå”åŠ©</button>
                </div>
            </div>

            <div id="message"></div>
            
            <div id="next-q-container">
                <button class="btn btn-secondary" id="prev-q-btn" onclick="history.back()">&laquo; ä¸Šä¸€é¡Œ</button>
                <button class="btn disabled" id="next-q-btn" onclick="nextQuestion()">ç¹¼çºŒå‰é€² &raquo;</button>
            </div>
        </div>

        <div id="final-screen" class="screen" style="text-align: center;">
            <h2>ğŸ‰ æ—…ç¨‹çµ‚ç« ï¼šé‡ç¾çš„å…‰å½±</h2>
            <div class="story-box" style="text-align: left;">
                <p>æ­å–œï¼åœ¨ä½ èˆ‡å¥½å¤¥ä¼´<span id="final-partner-name" class="fragment"></span>çš„å…±åŒåŠªåŠ›ä¸‹ï¼Œä½ å€‘æˆåŠŸæ”¶é›†äº†é—œæ–¼ã€Œé»‘é‡‘æ­²æœˆã€ã€ã€Œæºªæµç”Ÿæ…‹ã€èˆ‡ã€Œå±±åŸå»ºç¯‰ã€çš„ä¸‰å¡Šé—œéµè¨˜æ†¶ç¢ç‰‡ã€‚</p>
                <p>ç«™åœ¨é‡æ–°è¢«äººå€‘çè¦–çš„æ–‡å±±æºªç•”ï¼Œä½ çœ‹è‘—æ¸…æ¾ˆçš„æºªæ°´æ˜ ç…§è‘—åŠè…³æ¨“çš„å€’å½±ã€‚ä½ å€‘ç™¼ç¾ï¼Œå¾©ç”¦çŸ³ç¢‡çš„é—œéµï¼Œä¸åƒ…æ˜¯ç¡¬é«”çš„ä¿®å¾©ï¼Œæ›´æ˜¯é‡æ–°é€£çµäººèˆ‡åœŸåœ°ã€éå»èˆ‡æœªä¾†çš„é—œä¿‚ã€‚</p>
                <p>ã€Œå–µï½ã€å¤¥ä¼´è¹­äº†è¹­ä½ çš„è…³é‚Šï¼Œä¼¼ä¹åœ¨èªªï¼šè¬è¬ä½ è¨˜å¾—é€™è£¡çš„æ•…äº‹ã€‚</p>
            </div>
            <p style="margin-top: 30px; font-weight: bold; color: #ffb74d;">æ„Ÿè¬ä½ ç‚ºçŸ³ç¢‡å±±åŸæ‰€åšçš„ä¸€åˆ‡ï¼</p>
             <div style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="location.reload()">å†æ¬¡é€ è¨ªçŸ³ç¢‡ (é‡æ–°é–‹å§‹)</button>
            </div>
        </div>

    </div>
    </div>

    <div id="game-character-display" style="display: none;"></div>

    <script>
        // --- éŠæˆ²è³‡æ–™ ---
        const gameData = {
            partners: {
                'èŒ¶ç±³': { 
                    key: 'èŒ¶ç±³', name: 'èŒ¶ç±³ (ç”Ÿæ…‹è§€å¯Ÿå®¶)', 
                    desc: 'åå­—å–è‡ªçŸ³ç¢‡è‘—åçš„ã€ŒåŒ…ç¨®èŒ¶ã€ã€‚ç†±æ„›å¤§è‡ªç„¶ï¼Œå°æºªæµç”Ÿæ…‹ç­è‹¥æŒ‡æŒã€‚',
                    ability: 'ã€è‡ªç„¶æ„Ÿæ‡‰ã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'æºªæµç”Ÿæ…‹èˆ‡ç’°å¢ƒæŒ‡æ¨™', specialtyQ: ['2-1', '2-3', '2-5'] 
                },
                'ç…¤çƒ': { 
                    key: 'ç…¤çƒ', name: 'ç…¤çƒ (æ–‡å²æŒ–æ˜è€…)', 
                    desc: 'å…¨èº«é»‘å¾—ç™¼äº®ï¼Œè±¡å¾µçŸ³ç¢‡çš„ã€Œé»‘é‡‘ã€æ­²æœˆã€‚ç†ŸçŸ¥æ‰€æœ‰é—œæ–¼ç¤¦å‘çš„è€æ•…äº‹ã€‚',
                    ability: 'ã€æ­·å²å›æº¯ã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'ç¤¦æ¥­æ­·å²èˆ‡èšè½æ–‡åŒ–', specialtyQ: ['1-1', '1-3', '3-2'] 
                },
                'è±†è±†': { 
                    key: 'è±†è±†', name: 'è±†è±† (è€è¡—åš®å°)', 
                    desc: 'åå­—ä¾†è‡ªçŸ³ç¢‡çŸ¥åçš„ã€Œç™¾å¹´è±†è…ã€ã€‚æ˜¯å€‹åƒè²¨ï¼Œæœ€æ‡‚è€è¡—çš„å»ºç¯‰èˆ‡ç©ºé–“ç§˜å¯†ã€‚',
                    ability: 'ã€åœ°æ™¯å—…è¦ºã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'ç‰¹æ®Šå»ºç¯‰èˆ‡åœ°ç†ç©ºé–“', specialtyQ: ['1-2', '3-1', '3-4'] 
                },
                'å°çŸ³': { 
                    key: 'å°çŸ³', name: 'å°çŸ³ (å‰µç”Ÿè¨­è¨ˆå¸«)', 
                    desc: 'å–è‡ªã€ŒçŸ³ã€ç¢‡ä¹‹åã€‚å–œæ­¡æ–°èˆŠèåˆçš„äº‹ç‰©ï¼Œå°ç¤¾å€æœªä¾†çš„ç™¼å±•ç‰¹åˆ¥æœ‰æƒ³æ³•ã€‚',
                    ability: 'ã€å‰µæ„è…¦åŠ›ã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'ç¤¾å€å‰µç”Ÿèˆ‡æœªä¾†ç™¼å±•', specialtyQ: ['2-2', '2-4', '3-3'] 
                }
            },
            stages: [
                {
                    id: 0, title: 'ç¬¬ä¸€é—œï¼šé»‘é‡‘æ­²æœˆçš„é¤˜æš‰ (ç¤¦æ¥­è¨˜æ†¶)', fragment: 'ã€é»‘é‡‘è¨˜æ†¶ç¢ç‰‡ã€‘',
                    questions: [
                        { q: '1-1. çŸ³ç¢‡æ›¾æ˜¯åŒ—å°ç£é‡è¦çš„ç…¤ç¤¦ç”¢å€ã€‚åœ¨ç¤¦æ¥­é¼ç››æ™‚æœŸï¼Œç‚ºäº†å°‡å±±è£¡çš„ç…¤ç¤¦é‹é€å‡ºå»ï¼Œæœ€ä¸»è¦çš„äº¤é€šå·¥å…·æ˜¯ä»€éº¼ï¼Ÿ', options: ['A. è¼‰é‡å¡è»Šã€‚', 'B. è¼•ä¾¿éµé“(å°è»Š)èˆ‡äººåŠ›ã€‚', 'C. ç©ºä¸­çºœè»Šã€‚', 'D. é€éæ–‡å±±æºªæ°´é‹ã€‚'], answer: 'B' },
                        { q: '1-2. ç¤¦å·¥çš„å·¥ä½œç’°å¢ƒæ¥µåº¦è‰±éšªã€‚ç•¶æ™‚åœ¨ç¤¦å‘å£å¸¸æœƒç¥­æ‹œå“ªä½ç¥ç¥‡ï¼Œç¥ˆæ±‚é€²å…¥åœ°åº•å¾Œèƒ½å¹³å®‰æ­¸ä¾†ï¼Ÿ', options: ['A. åª½ç¥–ã€‚', 'B. é—œè–å¸å›ã€‚', 'C. åœŸåœ°å…¬ã€‚', 'D. æ¸…æ°´ç¥–å¸«ã€‚'], answer: 'C' },
                        { q: '1-3. éš¨è‘—1970å¹´ä»£å¾ŒçŸ³æ²¹å–ä»£ç…¤ç‚­ã€é€²å£ç…¤ç«¶çˆ­ï¼Œä»¥åŠå¹¾æ¬¡é‡å¤§çš„ç¤¦ç½ï¼Œå°ç£ç…¤ç¤¦æ¥­èµ°å‘æ²’è½ã€‚é€™å°çŸ³ç¢‡é€ æˆäº†ä»€éº¼ç›´æ¥å½±éŸ¿ï¼Ÿ', options: ['A. è½‰å‹ç‚ºé«˜ç§‘æŠ€åœ’å€ã€‚', 'B. å¤§é‡é’å£¯å¹´äººå£å¤–ç§»å°‹æ‰¾å·¥ä½œæ©Ÿæœƒã€‚', 'C. ç©ºæ°£å“è³ªç«‹åˆ»è®Šå¥½ï¼Œå¸å¼•å¤§é‡é¤Šè€äººå£ã€‚', 'D. æˆ¿åƒ¹é£†æ¼²ã€‚'], answer: 'B' },
                        { q: '1-4. å¦‚ä»Šåœ¨çŸ³ç¢‡å±±å€æ­¥é“å¥è¡Œæ™‚ï¼Œå¶çˆ¾èƒ½çœ‹è¦‹è¢«æ¤ç‰©è¦†è“‹çš„å»¢æ£„å‘å£éºè·¡ã€‚é¢å°é€™äº›éºè·¡ï¼Œæˆ‘å€‘æ‡‰è©²æŠ±æŒä»€éº¼æ…‹åº¦ï¼Ÿ', options: ['A. è¦–ç‚ºå±éšªåƒåœ¾ï¼Œæ‡‰ç›¡å¿«å¡«å¹³ã€‚', 'B. æŠŠå®ƒå€‘é–‹ç™¼æˆä¸»é¡Œæ¨‚åœ’é¬¼å±‹ã€‚', 'C. è¦–ç‚ºçè²´çš„ç”¢æ¥­æ–‡åŒ–åœ°æ™¯ï¼Œé€²è¡Œé©åº¦ä¿å­˜èˆ‡è§£èªªã€‚', 'D. é€²å…¥æ¢éšªå°‹å¯¶ã€‚'], answer: 'C' }
                    ]
                },
                {
                    id: 1, title: 'ç¬¬äºŒé—œï¼šæºªæµçš„ç„¡è²å‘Šç™½ (ç”Ÿæ…‹ç’°å¢ƒ)', fragment: 'ã€æ¸…æºªç”Ÿæ…‹ç¢ç‰‡ã€‘',
                    questions: [
                        { q: '2-1. æµç¶“çŸ³ç¢‡è€è¡—çš„æ ¸å¿ƒæºªæµæ˜¯å“ªä¸€æ¢ï¼Ÿå®ƒæ˜¯ç•¶åœ°å±…æ°‘ç”Ÿæ´»çš„é‡è¦å‘½è„ˆã€‚', options: ['A. æ·¡æ°´æ²³ã€‚', 'B. åŸºéš†æ²³ã€‚', 'C. æ–‡å±±æºª (æ™¯ç¾æºªä¸Šæ¸¸)ã€‚', 'D. åŒ—å‹¢æºªã€‚'], answer: 'C' },
                        { q: '2-2. éå»çš„ç¤¦æ¥­æ´»å‹•å¯èƒ½å°æºªæµç•™ä¸‹é•·æœŸçš„å½±éŸ¿ã€‚ä¸‹åˆ—ä½•è€…ã€Œä¸æ˜¯ã€ç¤¦å€å¸¸è¦‹çš„ç’°å¢ƒå¾Œéºç—‡ï¼Ÿ', options: ['A. å»¢ç¤¦å †åœ¨é›¨å¾Œæ²–åˆ·å‡ºé…¸æ€§å»¢æ°´ã€‚', 'B. æºªæµä¸­é‡é‡‘å±¬å«é‡æ½›åœ¨åé«˜ã€‚', 'C. æºªæ°´æº«åº¦ç•°å¸¸å‡é«˜è®Šæˆæº«æ³‰ã€‚', 'D. æ³¥æ²™æ·¤ç©å½±éŸ¿åº•æ£²ç”Ÿç‰©ã€‚'], answer: 'C' },
                        { q: '2-3. åœ¨é€²è¡Œæºªæµç”Ÿæ…‹å¾©è‚²æ™‚ï¼Œæˆ‘å€‘å¸Œæœ›èƒ½çœ‹åˆ°æŒ‡æ¨™æ€§ç”Ÿç‰©å›æ­¸ã€‚å¦‚æœä½ åœ¨æ–‡å±±æºªè£¡ç™¼ç¾äº†è¨±å¤šã€Œè‹¦èŠ±é­šã€æˆ–ã€ŒçŸ³è³“ã€ï¼Œé€™é€šå¸¸ä»£è¡¨ä»€éº¼æ„ç¾©ï¼Ÿ', options: ['A. æ°´è³ªéå¸¸æ··æ¿é«’æ±¡ã€‚', 'B. é€™è£¡æœ‰äººåœ¨é€²è¡Œå•†æ¥­é¤Šæ®–ã€‚', 'C. æ°´è³ªæ¸…æ¾ˆæº¶æ°§é«˜ï¼Œç”Ÿæ…‹ç‹€æ³è‰¯å¥½ã€‚', 'D. æºªæµå·²ç¶“å®Œå…¨é™¸åŸŸåŒ–ã€‚'], answer: 'C' },
                        { q: '2-4. ç‚ºäº†ä¿è­·çŸ³ç¢‡çš„æºªæµç’°å¢ƒï¼Œèº«ç‚ºéŠå®¢çš„æˆ‘å€‘ï¼Œä¸‹åˆ—å“ªå€‹è¡Œç‚ºæ˜¯æ­£ç¢ºçš„ï¼Ÿ', options: ['A. å°‡çƒ¤è‚‰å‰©ä¸‹çš„é£Ÿç‰©å€’å…¥æºªä¸­é¤µé­šã€‚', 'B. ä½¿ç”¨å°ç’°å¢ƒå‹å–„çš„é˜²æ›¬ä¹³ï¼Œä¸¦å°‡åƒåœ¾è‡ªè¡Œå¸¶èµ°ã€‚', 'C. éš¨æ„æ¬å‹•æºªä¸­çŸ³å¡Šæ•æ‰è¦èŸ¹ã€‚', 'D. åœ¨æºªé‚Šä½¿ç”¨åŒ–å­¸æ¸…æ½”åŠ‘æ´—æ»Œé¤å…·ã€‚'], answer: 'B' }
                    ]
                },
                {
                    id: 2, title: 'ç¬¬ä¸‰é—œï¼šå±±åŸçš„ç©ºé–“æ™ºæ…§ (èšè½èˆ‡å‰µç”Ÿ)', fragment: 'ã€å±±åŸå»ºç¯‰ç¢ç‰‡ã€‘',
                    questions: [
                        { q: '3-1. çŸ³ç¢‡æ±è¡—è‘—åçš„ã€ŒåŠè…³æ¨“ã€å»ºç¯‰æ™¯è§€ï¼Œå…¶å½¢æˆçš„æ ¹æœ¬åœ°ç†åŸå› æ˜¯ä»€éº¼ï¼Ÿ', options: ['A. ç‚ºäº†ç¾è§€èˆ‡è—è¡“æ„Ÿã€‚', 'B. è…¹åœ°ç‹¹å°ï¼Œç‚ºäº†çˆ­å–ç©ºé–“è€Œå°‡æˆ¿å±‹æ‡¸ç©ºè“‹åœ¨æºªåºŠä¸Šã€‚', 'C. ç‚ºäº†é˜²ç¦¦æ•µäººçš„é€²æ”»ã€‚', 'D. æ¨¡ä»¿åœ‹å¤–çš„æ°´ä¸Šå±‹è¨­è¨ˆã€‚'], answer: 'B' },
                        { q: '3-2. çŸ³ç¢‡ç‰¹æ®Šçš„ã€Œä¸è¦‹å¤©è¡—ã€ï¼Œæ˜¯æŒ‡æˆ¿å±‹äºŒæ¨“ç©ºé–“å‘å¤–å»¶ä¼¸è¦†è“‹äº†ä¸€æ¨“çš„è¡—é“ï¼Œå½¢æˆäº†æœ‰é®è”½çš„é€šé“ã€‚é€™ç¨®è¨­è¨ˆåœ¨å¤šé›¨çš„å±±åŸæœ‰ä»€éº¼å¯¦éš›åŠŸèƒ½ï¼Ÿ', options: ['A. è®“è¡Œäººèˆ‡å•†å®¶å¯ä»¥é®é¢¨é¿é›¨é€²è¡Œå•†æ¥­æ´»å‹•ã€‚', 'B. å®Œå…¨ç‚ºäº†é˜»æ“‹é™½å…‰ç…§å°„ã€‚', 'C. å¢åŠ å»ºç¯‰çµæ§‹çš„é‡é‡ã€‚', 'D. ç‚ºäº†åœ¨äºŒæ¨“ç¨®æ¤æ¤ç‰©ã€‚'], answer: 'A' },
                        { q: '3-3. è¿‘å¹´ä¾†ï¼Œè¨±å¤šåœ˜éšŠå›åˆ°çŸ³ç¢‡æ¨å‹•åœ°æ–¹å‰µç”Ÿã€‚ä¸‹åˆ—å“ªä¸€é …æ´»å‹•ã€Œæœ€ä¸ç¬¦åˆã€æ°¸çºŒå‰µç”Ÿçš„ç²¾ç¥ï¼Ÿ', options: ['A. é–‹ç™¼çµåˆåœ¨åœ°èŒ¶è‘‰èˆ‡æ¡‚èŠ±ç‰¹è‰²çš„å‰µæ„å•†å“ã€‚', 'B. èˆ‰è¾¦å°è¦½æ´»å‹•ï¼ŒåŸ¹è¨“åœ¨åœ°é•·è¼©è¨´èªªè‡ªå·±çš„æ•…äº‹ã€‚', 'C. å¼•é€²èˆ‡ç•¶åœ°æ–‡åŒ–ç„¡é—œçš„å¤§å‹é€£é–éŠæ¨‚å ´ã€‚', 'D. æ•´ä¿®è€å±‹ç©ºé–“ï¼Œä½œç‚ºè—æ–‡äº¤æµçš„æ“šé»ã€‚'], answer: 'C' },
                        { q: '3-4. èµ°åœ¨çŸ³ç¢‡è€è¡—ï¼Œä½ æœƒç™¼ç¾é€™è£¡çš„å»ºç¯‰èˆ‡ç©ºé–“å……æ»¿äº†ã€Œäººå‘³ã€èˆ‡æ­·å²ç—•è·¡ã€‚æƒ³è¦çœŸæ­£é«”é©—çŸ³ç¢‡çš„é­…åŠ›ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ï¼Ÿ', options: ['A. æ‹å®Œç…§å°±ç«‹åˆ»é›¢é–‹ã€‚', 'B. æ…¢ä¸‹ä¾†ï¼Œèµ°å…¥å··å¼„ï¼Œèˆ‡åœ¨åœ°å±…æ°‘äº’å‹•å°è©±ã€‚', 'C. åªå¾…åœ¨å†·æ°£æˆ¿è£¡ã€‚', 'D. æŠ±æ€¨é€™è£¡ä¸å¦‚éƒ½å¸‚ä¾¿åˆ©ã€‚'], answer: 'B' }
                    ]
                }
            ]
        };

        // --- ç‹€æ…‹è®Šæ•¸ ---
        let gameState = {
            currentStage: 0,
            currentQuestion: 0,
            fragmentsCollected: 0,
            score: 0,
            abilitiesUsed: { 0: false, 1: false, 2: false },
            isQuestionLocked: false,
            selectedPartnerKey: null,
            answers: {} 
        };

        const elements = {
            screens: document.querySelectorAll('.screen'),
            stageTitle: document.getElementById('stage-title'),
            progressText: document.getElementById('progress-text'),
            questionText: document.getElementById('question-text'),
            optionsList: document.getElementById('options-list'),
            abilityUI: document.getElementById('ability-ui'),
            currentAbility: document.getElementById('current-ability'),
            message: document.getElementById('message'),
            nextQBtn: document.getElementById('next-q-btn'),
            prevQBtn: document.getElementById('prev-q-btn'),
            partnerInfoText: document.getElementById('partner-info-text'),
            roleSelectionGrid: document.getElementById('role-selection-grid'),
            confirmRoleBtn: document.getElementById('confirm-role-btn'),
            gameCharacterDisplay: document.getElementById('game-character-display'),
            finalPartnerName: document.getElementById('final-partner-name')
        };

        // --- History API æ ¸å¿ƒé‚è¼¯ ---
        
        // åˆå§‹åŒ–ï¼šå–ä»£ç•¶å‰ç‹€æ…‹ç‚º start
        window.history.replaceState({ page: 'start-screen' }, '', '');

        // ç›£è½ç€è¦½å™¨çš„ä¸Šä¸€é /ä¸‹ä¸€é äº‹ä»¶ (popstate)
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                handleStateChange(event.state);
            } else {
                // å¦‚æœæ²’æœ‰ç‹€æ…‹ (æ¥µå°‘è¦‹)ï¼Œé è¨­å›é¦–é 
                showScreen('start-screen');
            }
        });

        // æ ¹æ“šæ­·å²ç‹€æ…‹ä¾†æ¸²æŸ“ç•«é¢
        function handleStateChange(state) {
            if (state.page === 'game-screen') {
                gameState.currentStage = state.stage;
                gameState.currentQuestion = state.question;
                // é€™è£¡ä¸å‘¼å« history.pushStateï¼Œå› ç‚ºæˆ‘å€‘æ˜¯æŒ‰ä¸Šä¸€é å›ä¾†çš„
                showScreen('game-screen');
                displayCharacterImage();
                renderGame(false); // false è¡¨ç¤ºä¸è¦å† push æ­·å²ç´€éŒ„
            } else {
                showScreen(state.page);
                if(state.page === 'select-role-screen') {
                    renderRoleSelection();
                }
            }
        }

        function showScreen(screenId) {
            elements.screens.forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            elements.gameCharacterDisplay.style.display = (screenId === 'game-screen') ? 'block' : 'none';
            window.scrollTo(0, 0); 
        }

        // æŒ‰ä¸‹ã€Œå‡ºç™¼å°‹æ‰¾ã€æ™‚å‘¼å«
        function goToRoleSelection() {
            history.pushState({ page: 'select-role-screen' }, '', '');
            showScreen('select-role-screen');
            renderRoleSelection();
        }

        function renderRoleSelection() {
            elements.roleSelectionGrid.innerHTML = '';
            const roleImages = { 'èŒ¶ç±³': '1.png', 'ç…¤çƒ': '2.png', 'è±†è±†': '3.png', 'å°çŸ³': '4.png' };

            Object.values(gameData.partners).forEach(partner => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.dataset.key = partner.key; 
                card.innerHTML = `
                    <div class="role-card-image">
                        <img src="assets/${roleImages[partner.key]}" alt="${partner.name}" onerror="this.style.display='none';this.parentNode.style.backgroundColor='#555';">
                    </div>
                    <div class="role-card-content">
                        <h3>${partner.name}</h3>
                        <p style="color: #bbb; font-size: 0.85em; margin-bottom: 8px;">${partner.desc}</p>
                        <p><strong>æ”¯æ´èƒ½åŠ›ï¼š</strong>${partner.ability}</p>
                    </div>
                `;
                card.onclick = (e) => {
                    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    elements.confirmRoleBtn.classList.remove('disabled');
                };
                elements.roleSelectionGrid.appendChild(card);
            });
        }

        function confirmRoleSelection() {
            const selectedCard = document.querySelector('.role-card.selected');
            if (selectedCard) {
                gameState.selectedPartnerKey = selectedCard.dataset.key; 
                startGame();
            }
        }

        function startGame() {
            gameState.currentStage = 0;
            gameState.currentQuestion = 0;
            gameState.fragmentsCollected = 0;
            gameState.score = 0;
            gameState.abilitiesUsed = { 0: false, 1: false, 2: false };
            gameState.answers = {}; 
            
            // Push åˆå§‹éŠæˆ²ç‹€æ…‹
            history.pushState({ page: 'game-screen', stage: 0, question: 0 }, '', '');
            
            showScreen('game-screen');
            displayCharacterImage(); 
            renderGame(false); // ç‹€æ…‹å·²æ‰‹å‹• pushï¼Œrender å…§ä¸éœ€å† push
        }

        function displayCharacterImage() {
            const roleImages = { 'èŒ¶ç±³': '1.png', 'ç…¤çƒ': '2.png', 'è±†è±†': '3.png', 'å°çŸ³': '4.png' };
            const imageName = roleImages[gameState.selectedPartnerKey];
            elements.gameCharacterDisplay.innerHTML = `<img src="assets/${imageName}" alt="å¤¥ä¼´ç«‹ç¹ª" onerror="this.style.display='none'">`;
        }

        // renderGame å¢åŠ  pushHistory åƒæ•¸æ§åˆ¶æ˜¯å¦è¦æ–°å¢æ­·å²ç´€éŒ„
        function renderGame(pushHistory = true) {
            if (gameState.currentStage >= gameData.stages.length) {
                return showFinalScreen();
            }

            // å¦‚æœéœ€è¦è¨˜éŒ„æ­·å² (ä¾‹å¦‚æŒ‰ä¸‹ä¸€é¡Œæ™‚)ï¼ŒåŸ·è¡Œ pushState
            if (pushHistory) {
                history.pushState({ 
                    page: 'game-screen', 
                    stage: gameState.currentStage, 
                    question: gameState.currentQuestion 
                }, '', '');
            }

            const stage = gameData.stages[gameState.currentStage];
            const currentQ = stage.questions[gameState.currentQuestion];
            const partner = gameData.partners[gameState.selectedPartnerKey];
            const answerKey = `${gameState.currentStage}-${gameState.currentQuestion}`;
            const recordedAnswer = gameState.answers[answerKey];

            elements.stageTitle.innerText = `${stage.title}`;
            elements.partnerInfoText.innerHTML = `ä½ çš„å–µå¤¥ä¼´ï¼š<strong>${partner.name.split(' ')[0]}</strong>`;
            elements.progressText.innerText = `é€²åº¦ï¼šç¬¬ ${gameState.currentStage + 1} é—œ - ç¬¬ ${gameState.currentQuestion + 1}/${stage.questions.length} é¡Œ`;
            elements.questionText.innerText = currentQ.q; 
            
            elements.message.innerText = '';
            elements.message.style.backgroundColor = 'transparent';
            elements.nextQBtn.classList.add('disabled');
            elements.nextQBtn.innerText = "ç¹¼çºŒå‰é€² Â»";
            
            // æ§åˆ¶ä¸Šä¸€é¡ŒæŒ‰éˆ•ï¼šå¦‚æœæ˜¯ç¬¬ä¸€é¡Œï¼Œç¦ç”¨ï¼›å¦å‰‡å•Ÿç”¨
            if (gameState.currentQuestion === 0 && gameState.currentStage === 0) {
                // ç¬¬ä¸€é—œç¬¬ä¸€é¡Œï¼Œä¸Šä¸€é æœƒå›åˆ°è§’è‰²é¸æ“‡ (ç”±ç€è¦½å™¨æ§åˆ¶)
                 elements.prevQBtn.classList.remove('disabled'); // è®“å®ƒèƒ½è§¸ç™¼ history.back()
                 elements.prevQBtn.innerHTML = "&laquo; å›é¸è§’";
            } else {
                 elements.prevQBtn.classList.remove('disabled');
                 elements.prevQBtn.innerHTML = "&laquo; ä¸Šä¸€é¡Œ";
            }

            if (recordedAnswer) {
                gameState.isQuestionLocked = true;
                elements.nextQBtn.classList.remove('disabled'); 
                const isCorrect = (recordedAnswer === currentQ.answer);
                if (isCorrect) {
                    elements.message.innerText = 'âœ… (å·²ä½œç­”) å›ç­”æ­£ç¢ºï¼å–µï¼';
                    elements.message.style.backgroundColor = 'rgba(212, 237, 218, 0.9)';
                    elements.message.style.color = '#155724';
                } else {
                    elements.message.innerText = `âŒ (å·²ä½œç­”) æ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentQ.answer}ã€‚`;
                    elements.message.style.backgroundColor = 'rgba(248, 215, 218, 0.9)';
                    elements.message.style.color = '#721c24';
                }
            } else {
                gameState.isQuestionLocked = false;
            }

            renderOptions(currentQ, recordedAnswer);
            renderAbilityUI(stage, currentQ, partner);
        }

        function renderOptions(question, recordedAnswer) {
            elements.optionsList.innerHTML = '';
            question.options.forEach(option => {
                const li = document.createElement('li');
                li.innerText = option;
                li.onclick = () => checkAnswer(option.charAt(0), li);
                
                if (recordedAnswer) {
                    li.classList.add('disabled');
                    if (option.charAt(0) === question.answer) {
                        li.classList.add('correct-answer');
                    } else if (option.charAt(0) === recordedAnswer && recordedAnswer !== question.answer) {
                        li.classList.add('wrong-answer');
                    }
                }
                elements.optionsList.appendChild(li);
            });
        }

        function renderAbilityUI(stage, currentQ, partner) {
            const abilityBtn = elements.abilityUI.querySelector('.ability-btn');
            const questionId = currentQ.q.split('.')[0]; 
            const isSpecialtyQ = partner.specialtyQ.includes(questionId);
            elements.currentAbility.innerText = partner.ability;

            if (gameState.abilitiesUsed[stage.id]) {
                abilityBtn.innerText = 'æœ¬é—œå–µå–µæ”¯æ´å·²ç”¨é';
                abilityBtn.classList.add('disabled');
            } else if (isSpecialtyQ) {
                abilityBtn.innerText = `è«‹æ±‚ ${partner.name.split(' ')[0]} å”åŠ©`;
                if (!gameState.isQuestionLocked) {
                    abilityBtn.classList.remove('disabled');
                } else {
                    abilityBtn.classList.add('disabled');
                }
            } else {
                abilityBtn.innerText = 'æ­¤é¡Œéå–µå¤¥ä¼´ç†Ÿæ‚‰é ˜åŸŸ';
                abilityBtn.classList.add('disabled');
            }
        }

        function useAbility() {
            const stage = gameData.stages[gameState.currentStage];
            const partner = gameData.partners[gameState.selectedPartnerKey];
            const currentQ = stage.questions[gameState.currentQuestion];
            const questionId = currentQ.q.split('.')[0];

            if (gameState.abilitiesUsed[stage.id] || gameState.isQuestionLocked || !partner.specialtyQ.includes(questionId)) return;

            const correctOptChar = currentQ.answer;
            const optionElements = Array.from(elements.optionsList.children);
            let wrongOptions = optionElements.filter(el => el.innerText.charAt(0) !== correctOptChar);
            
            for (let i = 0; i < 2 && wrongOptions.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * wrongOptions.length);
                wrongOptions[randomIndex].style.visibility = 'hidden'; 
                wrongOptions[randomIndex].classList.add('disabled'); 
                wrongOptions.splice(randomIndex, 1);
            }

            gameState.abilitiesUsed[stage.id] = true;
            renderAbilityUI(stage, currentQ, partner);
            elements.message.innerText = `ğŸ’¡ ${partner.name.split(' ')[0]} ä¼¸å‡ºäº†è²“æŒï¼Œå¹«ä½ æ’¥é–‹äº†å¹²æ“¾é¸é …ï¼`;
            elements.message.style.backgroundColor = 'rgba(255, 255, 204, 0.9)';
            elements.message.style.color = '#333';
        }

        function checkAnswer(selectedOptionChar, liElement) {
            if (gameState.isQuestionLocked || liElement.classList.contains('disabled')) return;

            const currentQ = gameData.stages[gameState.currentStage].questions[gameState.currentQuestion];
            const isCorrect = (selectedOptionChar === currentQ.answer);

            const answerKey = `${gameState.currentStage}-${gameState.currentQuestion}`;
            gameState.answers[answerKey] = selectedOptionChar;

            gameState.isQuestionLocked = true;
            elements.nextQBtn.classList.remove('disabled');

            Array.from(elements.optionsList.children).forEach(item => {
                item.classList.add('disabled');
                if (item.innerText.charAt(0) === currentQ.answer) {
                    item.classList.add('correct-answer');
                } else if (item === liElement && !isCorrect) {
                    item.classList.add('wrong-answer');
                }
            });

            if (isCorrect) {
                gameState.score++;
                elements.message.innerText = 'âœ… ç­”å°äº†ï¼å–µï¼';
                elements.message.style.backgroundColor = 'rgba(212, 237, 218, 0.9)';
                elements.message.style.color = '#155724';
            } else {
                elements.message.innerText = `âŒ å–µå—š...ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ ${currentQ.answer}ã€‚`;
                elements.message.style.backgroundColor = 'rgba(248, 215, 218, 0.9)';
                elements.message.style.color = '#721c24';
            }
        }

        function nextQuestion() {
            if (!gameState.isQuestionLocked) return;

            gameState.currentQuestion++;
            const stage = gameData.stages[gameState.currentStage];

            if (gameState.currentQuestion >= stage.questions.length) {
                gameState.fragmentsCollected++;
                elements.message.innerText = `ğŸ‰ é—œå¡å®Œæˆï¼ç²å¾—${stage.fragment}ã€‚æº–å‚™å‰å¾€ä¸‹ä¸€ç«™...`;
                elements.message.style.backgroundColor = 'rgba(255, 183, 77, 0.9)';
                elements.nextQBtn.innerText = "å‰å¾€ä¸‹ä¸€é—œ Â»";
                
                setTimeout(() => {
                    gameState.currentStage++;
                    gameState.currentQuestion = 0;
                    renderGame(); // é€™è£¡æœƒè‡ªå‹• push æ­·å²ç´€éŒ„
                }, 1500);
            } else {
                renderGame(); // é€™è£¡æœƒè‡ªå‹• push æ­·å²ç´€éŒ„
            }
        }
        
        function showFinalScreen() {
            elements.finalPartnerName.innerText = gameData.partners[gameState.selectedPartnerKey].name.split(' ')[0];
            history.pushState({ page: 'final-screen' }, '', '');
            showScreen('final-screen');
        }

        // åˆå§‹è¼‰å…¥
        showScreen('start-screen');

    </script>
</body>
</html>
