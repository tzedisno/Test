<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ³ç¢‡è¨˜æ†¶ï¼šå±±åŸè²“å’ªçš„é‚€è«‹å‡½</title>
    <style>
        /* CSS æ¨£å¼ */
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background: linear-gradient(rgba(20,30,40,0.7), rgba(40,30,20,0.6)), url('assets/bg.jpg') center/cover fixed no-repeat;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(40, 40, 40, 0.9); 
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            padding: 40px;
            position: relative;
        }
        #outer-wrap {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 10px;
            box-sizing: border-box;
        }
 
        h1 {
            color: #ffcc80;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #ddd;
            font-style: italic;
            margin-bottom: 30px;
            display: block;
            font-size: 1.1em;
            letter-spacing: 1px;
        }

        h2 {
            color: #ffb74d;
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,183,77,0.3);
        }
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            background-color: #ffb74d;
            color: #333;
            border: none;
            padding: 12px 30px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn:hover:not(.disabled) {
            background-color: #ffa726;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-secondary {
            background-color: transparent;
            border: 2px solid #aaa;
            color: #aaa;
        }
        .btn-secondary:hover:not(.disabled) {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
            border-color: #fff;
        }
        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            pointer-events: none;
        }

        .story-box {
            padding: 20px;
            background-color: rgba(255,255,255,0.1);
            border-left: 4px solid #ffb74d;
            border-radius: 4px;
            margin-bottom: 25px;
            line-height: 1.7;
            font-size: 1.05em;
        }

        .coupon-box {
            background-color: #fff;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #ffb74d;
            margin: 20px auto;
            max-width: 400px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .coupon-title {
            color: #e65100;
            font-size: 1.5em;
            margin-bottom: 10px;
            border-bottom: 2px solid #e65100;
            display: inline-block;
        }
        .coupon-code {
            background: #eee;
            padding: 10px;
            font-family: monospace;
            font-size: 1.2em;
            letter-spacing: 2px;
            margin: 15px 0;
            font-weight: bold;
        }

        .sdg-tag {
            display: inline-block;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            margin-right: 8px;
            vertical-align: middle;
            font-weight: normal;
        }
        .sdg-15 { background-color: #56C02B; }
        .sdg-11 { background-color: #FD9D24; }
        .sdg-8 { background-color: #A21942; }
        .sdg-4 { background-color: #C5192D; }
        .sdg-6 { background-color: #26BDE2; }
        .sdg-17 { background-color: #19486A; }

        .explanation-box {
            margin-top: 15px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid #81c784;
            border-radius: 0 4px 4px 0;
            font-size: 0.95em;
            color: #eee;
            text-align: left;
            display: none;
            line-height: 1.6;
        }
        .explanation-title {
            font-weight: bold;
            color: #81c784;
            display: block;
            margin-bottom: 5px;
        }

        /* Overlay */
        #victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        #victory-overlay.fade-in {
            display: flex;
            animation: overlayFadeIn 0.5s forwards;
        }
        
        #victory-overlay.fade-out {
            animation: overlayFadeOut 0.5s forwards;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes overlayFadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        #victory-content {
            text-align: center;
            transform: scale(0.8);
            animation: popUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popUp {
            to { transform: scale(1); }
        }

        #victory-content img {
            max-width: 80%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 183, 77, 0.6);
            margin-bottom: 20px;
        }

        #victory-content h2 {
            color: #ffb74d;
            font-size: 2em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        #victory-content p {
            color: #fff;
            font-size: 1.2em;
            margin-top: 10px;
        }

        #role-selection-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }
        .role-card {
            border: 2px solid rgba(255, 128, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            background-color: rgba(60,60,60,0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            color: #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .role-card-image {
            flex-shrink: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #2a2a2a;
            border: 3px solid rgba(255,255,255,0.1);
        }
        .role-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .role-card-content {
            flex: 1;
        }
        .role-card:hover:not(.selected) {
            background-color: rgba(80,80,80,0.5);
            border-color: rgba(255, 128, 0, 0.6);
        }
        .role-card.selected {
            border-color: #ffb74d;
            background-color: rgba(255, 183, 77, 0.15);
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.3);
        }
        .role-card h3 {
            color: #ffb74d;
            margin: 0 0 8px 0;
            font-size: 1.2em;
        }
        .role-card p {
            margin: 4px 0;
            font-size: 0.9em;
            color: #ccc;
        }

        .question-box {
            background-color: rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        #question-text {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fff;
            line-height: 1.5;
        }
        .options-list {
            list-style: none;
            padding: 0;
        }
        .options-list li {
            background-color: rgba(70,70,70,0.5);
            margin: 10px 0;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        .options-list li:hover:not(.disabled) {
            background-color: rgba(90,90,90,0.7);
            border-color: #64b5f6;
        }
        .options-list li.correct-answer { background-color: rgba(46, 125, 50, 0.6); border-color: #4caf50; color: #fff; }
        .options-list li.wrong-answer { background-color: rgba(198, 40, 40, 0.6); border-color: #f44336; color: #fff; opacity: 0.7; }
        
        .ability-box {
            background-color: rgba(255, 183, 77, 0.1);
            border: 1px solid rgba(255, 183, 77, 0.3);
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ability-info {
            flex: 1;
        }
        .ability-btn {
            background-color: #ffb74d;
            color: #222;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            flex-shrink: 0;
            margin-left: 15px;
        }
        .ability-btn:hover:not(.disabled) { background-color: #ffa726; box-shadow: 0 4px 8px rgba(255, 167, 38, 0.4); }

        #message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            min-height: 20px;
        }
        .fragment { color: #ffb74d; font-weight: bold; }
        
        #player-role-display {
            background: linear-gradient(to right, rgba(40,40,40,0), rgba(100, 181, 246, 0.1));
            border-left: 4px solid #64b5f6;
            padding: 10px 15px;
            margin-bottom: 20px;
            color: #ccc;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .specialty-q-hint { font-size: 0.9em; color: #81c784; }

        #game-character-display {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 160px;
            height: auto;
            z-index: 100;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            transition: transform 0.3s ease;
        }
        #game-character-display:hover {
             transform: translateY(-5px) scale(1.05);
        }
        #game-character-display img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #next-q-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        @media (max-width: 768px) {
            body { padding: 10px; align-items: flex-start; }
            #game-container { padding: 25px 20px; margin-top: 20px; }
            #role-selection-grid { grid-template-columns: 1fr; gap: 15px; }
            .role-card-image { width: 80px; height: 80px; }
            .ability-box { flex-direction: column; text-align: left; align-items: flex-start; }
            .ability-btn { margin-left: 0; margin-top: 15px; width: 100%; }
            #game-character-display { width: 120px; bottom: 15px; left: 15px; opacity: 0.8; }
            #player-role-display { flex-direction: column; align-items: flex-start; gap: 5px; }
        }
    </style>
</head>
<body>
    
    <div id="victory-overlay">
        <div id="victory-content">
            <img src="assets/winner.gif" alt="Winner Animation">
            <h2>ğŸ‰ æ‹¼åœ–æ”¶é›†å®Œæˆï¼</h2>
            <p>æ­£åœ¨ç‚ºæ‚¨é–‹å•Ÿå‰å¾€çŸ³ç¢‡çš„é€šé“...</p>
        </div>
    </div>

    <div id="outer-wrap">

    <div id="game-container">
        <header>
            <h1>
                <img id="site-logo" src="assets/logo.png" alt="çŸ³ç¢‡è¨˜æ†¶" style="max-width: 320px; width: 100%; height: auto; display: block; margin: 0 auto;">
            </h1>
            <span class="subtitle">â€” è·Ÿéš¨è²“å’ªè¶³è·¡ï¼Œé‡å•Ÿå±±åŸè¨˜æ†¶ â€”</span>
        </header>

        <div id="start-screen" class="screen">
            <h2>ğŸ“œ å‰è¨€ï¼šä¾†è‡ªå±±åŸçš„é‚€è«‹</h2>
            <div class="story-box">
                <p>è¦ªæ„›çš„æ—…äººï¼Œä½ å¥½ï¼š</p>
                <p>ä½ æˆ–è¨±è½éçŸ³ç¢‡ï¼ŒçŸ¥é“é‚£è£¡æœ‰è€è¡—èˆ‡æºªæµã€‚ä½†æœ€è¿‘ï¼Œæ–‡å±±æºªçš„æ°´è²è®Šå¾—æœ‰äº›å¾®å¼±ï¼Œåƒæ˜¯æœ‰äº›è€æ•…äº‹å¿«è¦è¢«éºå¿˜äº†ã€‚</p>
                <p>ä½åœ¨é€™è£¡çš„å››éš»<strong>ã€Œå®ˆè­·è²“å’ªã€</strong>å¸Œæœ›èƒ½é‚€è«‹çœŸæ­£æ‡‚é€™è£¡çš„äººï¼ŒåƒåŠ ä¸€å ´ç‰¹åˆ¥çš„<strong>ã€Œå±±åŸè¦‹é¢æœƒã€</strong>ã€‚</p>
                <p>ä½†å…¥å ´åˆ¸è—åœ¨éå¾€çš„æ™‚å…‰è£¡ã€‚ä½ é¡˜æ„æˆç‚ºæˆ‘å€‘çš„å¤¥ä¼´ï¼Œä¸€èµ·æ‰¾å›å¤±è½çš„æ­·å²ã€ç”Ÿæ…‹èˆ‡å»ºç¯‰è¨˜æ†¶ï¼Œä¸¦ç²å¾—é€™å¼µçè²´çš„å…¥å ´åˆ¸å—ï¼Ÿ</p>
            </div>
            <div style="text-align: center;">
                <p><strong>æ—…ç¨‹ç›®æ¨™ï¼š</strong> æ”¶é›†ä¸‰å¡Šè¨˜æ†¶æ‹¼åœ–ï¼Œé€šéæœ€çµ‚çš„è¡Œå‰ç¢ºèªï¼Œå³å¯ç²å¾—<strong>ã€Œä¸è¦‹å¤©è¡—-ç¥ç§˜è¦‹é¢ç¦®ã€</strong>ï¼</p>
                <button class="btn" onclick="goToRoleSelection()">æ¥å—é‚€è«‹ï¼Œå°‹æ‰¾åš®å°</button>
            </div>
        </div>

        <div id="select-role-screen" class="screen">
            <h2>ğŸ¾ é¸æ“‡ä½ çš„åš®å°è²“å’ª</h2>
            <p>é€™å¹¾ä½è²“å’ªæ˜¯çŸ³ç¢‡æœ€è³‡æ·±çš„åœ¨åœ°å±…æ°‘ï¼Œè«‹é¸æ“‡ä¸€ä½æœ€æŠ•ç·£çš„å¤¥ä¼´é™ªä½ æ¢ç´¢ï¼š</p>
            
            <div id="role-selection-grid">
                </div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn-secondary" onclick="history.back()">&laquo; è¿”å›æ¨™é¡Œ</button>
                <button class="btn disabled" id="confirm-role-btn" onclick="confirmRoleSelection()">èˆ‡ç‰ åŒè¡Œï¼Œé–‹å§‹æ—…ç¨‹ &raquo;</button>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="player-role-display">
                <span id="partner-info-text"></span>
                <span id="progress-text" style="font-weight: bold; color: #ffb74d;"></span>
            </div>

            <h2 id="stage-title">é—œå¡æ¨™é¡Œ</h2>
            
            <div id="question-area" class="question-box">
                <p id="question-text"></p>
                <ul id="options-list" class="options-list">
                    </ul>
                
                <div id="explanation-area" class="explanation-box">
                    <span class="explanation-title">ğŸ’¡ è²“å’ªåš®å°çš„å°çŸ¥è­˜ï¼š</span>
                    <span id="explanation-text"></span>
                </div>

                <div id="ability-ui" class="ability-box">
                    <div class="ability-info">
                        <strong>è²“æŒæ”¯æ´ï¼š</strong> <span id="current-ability"></span>
                        <div style="font-size: 0.85em; margin-top: 5px; color: #aaa;">(æ³¨: è²“å’ªåªèƒ½åœ¨ç†Ÿæ‚‰çš„é ˜åŸŸå¹«å¿™æ’é™¤é¸é …ï¼Œæ¯é—œé™ç”¨ä¸€æ¬¡ã€‚)</div>
                    </div>
                    <button class="ability-btn" onclick="useAbility()">å‘¼å«è²“å’ªå¹«å¿™</button>
                </div>
            </div>

            <div id="message"></div>
            
            <div id="next-q-container">
                <button class="btn btn-secondary" id="prev-q-btn" onclick="history.back()">&laquo; ä¸Šä¸€é¡Œ</button>
                <button class="btn disabled" id="next-q-btn" onclick="nextQuestion()">ç¹¼çºŒå‰é€² &raquo;</button>
            </div>
        </div>

        <div id="final-screen" class="screen" style="text-align: center;">
            <h2>ğŸ‰ æ—…ç¨‹çµ‚ç« ï¼šå‰å¾€ä¸è¦‹å¤©è¡—</h2>
            <div class="story-box" style="text-align: left;">
                <p>æ­å–œä½ ï¼ä½ ä¸åƒ…æ‰¾å›äº†éºå¤±çš„è¨˜æ†¶ï¼Œæ›´å±•ç¾äº†å°é€™ç‰‡åœŸåœ°çš„æº«æŸ”èˆ‡å°Šé‡ã€‚</p>
                <p>ä½ çš„è²“å’ªå¤¥ä¼´<span id="final-partner-name" class="fragment"></span>é–‹å¿ƒåœ°è¹­äº†è¹­ä½ çš„è…³é‚Šï¼Œç‰ èªªï¼šã€Œæˆ‘å€‘åœ¨è€è¡—ç­‰ä½ å–”ï¼ã€</p>
                <p>è«‹å¸¶è‘—ä¸‹æ–¹é€™å¼µ<strong>ã€Œè²“å’ªçš„è¬ç¦®ã€</strong>ï¼Œè¦ªè‡ªå‰å¾€çŸ³ç¢‡çš„<strong>ä¸è¦‹å¤©è¡—</strong>ï¼ˆæˆ–æŒ‡å®šåˆä½œåº—å®¶ï¼‰ï¼Œå…Œæ›é€™ä»½å¿ƒæ„ã€‚</p>
                
                <div class="coupon-box">
                    <div class="coupon-title">ğŸ è²“å¤¥ä¼´çš„è¦‹é¢ç¦®</div>
                    <p style="margin: 5px 0; font-size: 0.9em; color: #555;">æ†‘æ­¤ç•«é¢å¯è‡³çŸ³ç¢‡æŒ‡å®šåº—å®¶å…Œæ›ï¼š</p>
                    <div class="coupon-code" id="coupon-code-text">LOADING...</div>
                    <p style="font-size: 1.1em; color: #e65100; font-weight: bold;">ã€çŸ³ç¢‡ç‰¹è‰²å°ç¦® / å°ˆå±¬å„ªæƒ ã€‘</p>
                    <p style="font-size: 0.8em; color: #999;">(è«‹å‘åº—å®¶å‡ºç¤ºæ­¤ç•«é¢)</p>
                </div>

                <p style="text-align: center; color: #ffb74d; font-weight: bold;">æœŸå¾…åœ¨çœŸå¯¦çš„çŸ³ç¢‡èˆ‡ä½ ç›¸é‡ï¼</p>
            </div>
             <div style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="location.reload()">é‡æ–°é–‹å§‹æ—…ç¨‹</button>
            </div>
        </div>

    </div>
    </div>

    <div id="game-character-display" style="display: none;"></div>

    <script>
        // --- éš¨æ©Ÿå›é¥‹èªéŒ„ ---
        const feedbackMessages = {
            correct: [
                "âœ… ç­”å°äº†ï¼å–µï¼çœŸä¸æ„§æ˜¯æˆ‘çš„å¥½å¤¥ä¼´ï¼",
                "âœ… å¤ªæ£’äº†ï¼ä½ çš„è§€å¯ŸåŠ›çœŸæ•éŠ³ï¼",
                "âœ… æ­£ç¢ºï¼æˆ‘å€‘é›¢çœŸç›¸è¶Šä¾†è¶Šè¿‘äº†ï¼",
                "âœ… å–µå—šï½é¸å¾—å¥½ï¼é€™å°±æ˜¯æ­£ç¢ºç­”æ¡ˆï¼",
                "âœ… è³“æœï¼çœ‹ä¾†ä½ å¾ˆæ‡‚çŸ³ç¢‡å–”ï¼"
            ],
            wrong: [
                "âŒ å–µå—š...é€™é¡Œæœ‰é»é›£ï¼Œæ­£ç¢ºç­”æ¡ˆå…¶å¯¦æ˜¯ ",
                "âŒ å“å‘€ï¼Œå·®ä¸€é»é»ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ",
                "âŒ å–µï¼Ÿå¥½åƒä¸å¤ªå°å–”ï¼Œç­”æ¡ˆæ‡‰è©²æ˜¯ ",
                "âŒ æ²’é—œä¿‚ï¼Œæˆ‘å€‘å­¸åˆ°äº†ä¸€èª²ã€‚æ­£ç¢ºæ˜¯ ",
                "âŒ å’¦ï¼Ÿé€™é¡Œçš„é™·é˜±æœ‰é»æ·±ã€‚ç­”æ¡ˆæ˜¯ "
            ]
        };

        // --- éŠæˆ²è³‡æ–™ ---
        const gameData = {
            partners: {
                'èŒ¶ç±³': { key: 'èŒ¶ç±³', imgBase: '1', name: 'èŒ¶ç±³ (ç”Ÿæ…‹è§€å¯Ÿå®¶)', desc: 'åå­—å–è‡ªçŸ³ç¢‡è‘—åçš„ã€ŒåŒ…ç¨®èŒ¶ã€ã€‚ç†±æ„›å¤§è‡ªç„¶ï¼Œå°æºªæµç”Ÿæ…‹ç­è‹¥æŒ‡æŒã€‚', ability: 'ã€è‡ªç„¶æ„Ÿæ‡‰ã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'æºªæµç”Ÿæ…‹èˆ‡ç’°å¢ƒæŒ‡æ¨™', specialtyQ: ['2-1', '2-3', '2-5', '4-2'] },
                'ç…¤çƒ': { key: 'ç…¤çƒ', imgBase: '2', name: 'ç…¤çƒ (æ–‡å²æŒ–æ˜è€…)', desc: 'å…¨èº«é»‘å¾—ç™¼äº®ï¼Œè±¡å¾µçŸ³ç¢‡çš„ã€Œé»‘é‡‘ã€æ­²æœˆã€‚ç†ŸçŸ¥æ‰€æœ‰é—œæ–¼ç¤¦å‘çš„è€æ•…äº‹ã€‚', ability: 'ã€æ­·å²å›æº¯ã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'ç¤¦æ¥­æ­·å²èˆ‡èšè½æ–‡åŒ–', specialtyQ: ['1-1', '1-3', '3-2', '4-1'] },
                'è±†è±†': { key: 'è±†è±†', imgBase: '3', name: 'è±†è±† (è€è¡—åš®å°)', desc: 'åå­—ä¾†è‡ªçŸ³ç¢‡çŸ¥åçš„ã€Œç™¾å¹´è±†è…ã€ã€‚æ˜¯å€‹åƒè²¨ï¼Œæœ€æ‡‚è€è¡—çš„å»ºç¯‰èˆ‡ç©ºé–“ç§˜å¯†ã€‚', ability: 'ã€åœ°æ™¯å—…è¦ºã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'ç‰¹æ®Šå»ºç¯‰èˆ‡åœ°ç†ç©ºé–“', specialtyQ: ['1-2', '3-1', '3-4', '4-1'] },
                'å°çŸ³': { key: 'å°çŸ³', imgBase: '4', name: 'å°çŸ³ (å‰µç”Ÿè¨­è¨ˆå¸«)', desc: 'å–è‡ªã€ŒçŸ³ã€ç¢‡ä¹‹åã€‚å–œæ­¡æ–°èˆŠèåˆçš„äº‹ç‰©ï¼Œå°ç¤¾å€æœªä¾†çš„ç™¼å±•ç‰¹åˆ¥æœ‰æƒ³æ³•ã€‚', ability: 'ã€å‰µæ„è…¦åŠ›ã€‘åˆªå»å…©å€‹éŒ¯èª¤é¸é …', field: 'ç¤¾å€å‰µç”Ÿèˆ‡æœªä¾†ç™¼å±•', specialtyQ: ['2-2', '2-4', '3-3', '4-3'] }
            },
            stages: [
                {
                    id: 0, title: 'ç¬¬ä¸€ç«™ï¼šé»‘é‡‘æ­²æœˆçš„é¤˜æš‰ (æ­·å²è¨˜æ†¶)', fragment: 'ã€æ­·å²æ‹¼åœ–ã€‘',
                    questions: [
                        { q: '1-1. çŸ³ç¢‡æ›¾æ˜¯åŒ—å°ç£é‡è¦çš„ç…¤ç¤¦ç”¢å€ã€‚åœ¨é‚„æ²’æœ‰å¤§é¦¬è·¯çš„å¹´ä»£ï¼Œè¦å°‡å±±è£¡çš„ç…¤ç¤¦é‹é€å‡ºå»ï¼Œæœ€ä¸»è¦æ˜¯é ä»€éº¼äº¤é€šå·¥å…·ï¼Ÿ', options: ['A. å¤§å¡è»Šã€‚', 'B. è¼•ä¾¿éµé“(å°è»Š)èˆ‡äººåŠ›ã€‚', 'C. ç©ºä¸­çºœè»Šã€‚', 'D. é€éæ–‡å±±æºªæ°´é‹ã€‚'], answer: 'B', sdg: 'sdg-8', sdgText: 'SDG 8 å°±æ¥­èˆ‡ç¶“æ¿Ÿ', explanation: 'æ—©æœŸå±±å€é“è·¯æœªé–‹é€šï¼Œç…¤ç¤¦é‹è¼¸ä¸»è¦å€šé é‹ªè¨­è¼•ä¾¿éµè»Œçš„äººåŠ›å°è»Šï¼Œé€™ä¹Ÿæ˜¯ç•¶æ™‚çŸ³ç¢‡å¸¸è¦‹çš„é¢¨æ™¯ã€‚' },
                        { q: '1-2. ç¤¦å·¥çš„å·¥ä½œéå¸¸å±éšªï¼Œé€²å…¥æ¼†é»‘çš„ç¤¦å‘å‰ï¼Œé€šå¸¸æœƒç¥­æ‹œå“ªä½ç¥ç¥‡ç¥ˆæ±‚å¹³å®‰æ­¸ä¾†ï¼Ÿ', options: ['A. åª½ç¥–ã€‚', 'B. é—œè–å¸å›ã€‚', 'C. åœŸåœ°å…¬ã€‚', 'D. æ¸…æ°´ç¥–å¸«ã€‚'], answer: 'C', sdg: 'sdg-11', sdgText: 'SDG 11 æ°¸çºŒåŸé„‰', explanation: 'åœŸåœ°å…¬è¢«è¦–ç‚ºåœ°æ–¹å®ˆè­·ç¥ï¼Œå°æ–¼åœ¨ã€Œåœ°åº•ä¸‹ã€å·¥ä½œçš„ç¤¦å·¥ä¾†èªªï¼Œæ˜¯å¿ƒéˆæœ€é‡è¦çš„å¯„è¨—ã€‚' },
                        { q: '1-3. 1970å¹´ä»£å¾Œï¼ŒçŸ³ç¢‡çš„ç…¤ç¤¦ç”¢æ¥­é€æ¼¸æ²’è½ï¼Œé€™å°ç•¶åœ°é€ æˆäº†ä»€éº¼æœ€ç›´æ¥çš„å½±éŸ¿ï¼Ÿ', options: ['A. è®Šæˆé«˜ç§‘æŠ€åœ’å€ã€‚', 'B. é’å£¯å¹´äººå£ç‚ºäº†å·¥ä½œè¢«è¿«å¤–ç§»ã€‚', 'C. ç©ºæ°£è®Šå¥½ï¼Œå¤§å®¶ç«‹åˆ»å›ä¾†é¤Šè€ã€‚', 'D. æˆ¿åƒ¹çªç„¶æš´æ¼²ã€‚'], answer: 'B', sdg: 'sdg-8', sdgText: 'SDG 8 å°±æ¥­èˆ‡ç¶“æ¿Ÿ', explanation: 'ç”¢æ¥­æ²’è½ç›´æ¥å°è‡´å·¥ä½œæ©Ÿæœƒæ¶ˆå¤±ï¼Œé’å£¯å¹´äººå£ç‚ºäº†ç”Ÿè¨ˆè¢«è¿«å¤–ç§»ï¼Œæ˜¯è¨±å¤šç¤¦æ¥­èšè½å…±åŒçš„å‚·ç—›ã€‚' },
                        { q: '1-4. å¦‚æœåœ¨å±±ä¸Šç™¼ç¾è¢«æ¤ç‰©è¦†è“‹çš„èˆŠç¤¦å‘å£ï¼Œæˆ‘å€‘æ‡‰è©²æŠ±æŒä»€éº¼æ…‹åº¦ï¼Ÿ', options: ['A. ç•¶ä½œåƒåœ¾å ´ã€‚', 'B. æ”¹å»ºæˆéŠæ¨‚åœ’é¬¼å±‹ã€‚', 'C. è¦–ç‚ºçè²´çš„æ–‡åŒ–åœ°æ™¯ï¼ŒåŠ ä»¥ä¿å­˜è§£èªªã€‚', 'D. é€²å»æ¢éšªå°‹å¯¶ã€‚'], answer: 'C', sdg: 'sdg-11', sdgText: 'SDG 11 æ–‡åŒ–ä¿å­˜', explanation: 'é€™äº›éºè·¡è¦‹è­‰äº†å°ç£èƒ½æºç™¼å±•çš„æ­·å²ï¼Œæ˜¯çè²´çš„æ–‡åŒ–è³‡ç”¢ï¼Œä¹Ÿæ˜¯çŸ³ç¢‡æ•…äº‹çš„ä¸€éƒ¨åˆ†ã€‚' }
                    ]
                },
                {
                    id: 1, title: 'ç¬¬äºŒç«™ï¼šè½è¦‹æºªæµçš„è²éŸ³ (ç”Ÿæ…‹ç’°å¢ƒ)', fragment: 'ã€ç”Ÿæ…‹æ‹¼åœ–ã€‘',
                    questions: [
                        { q: '2-1. æµç¶“çŸ³ç¢‡è€è¡—çš„é‚£æ¢ç¾éº—æºªæµï¼Œæ˜¯ç•¶åœ°å±…æ°‘ç”Ÿæ´»çš„é‡è¦å¤¥ä¼´ï¼Œå®ƒçš„åå­—æ˜¯ï¼Ÿ', options: ['A. æ·¡æ°´æ²³ã€‚', 'B. åŸºéš†æ²³ã€‚', 'C. æ–‡å±±æºª (æ™¯ç¾æºªä¸Šæ¸¸)ã€‚', 'D. åŒ—å‹¢æºªã€‚'], answer: 'C', sdg: 'sdg-6', sdgText: 'SDG 6 æ·¨æ°´èˆ‡è¡›ç”Ÿ', explanation: 'æµç¶“çŸ³ç¢‡çš„æ˜¯æ™¯ç¾æºªçš„ä¸Šæ¸¸ï¼Œåœ¨åœ°äººå¸¸ç¨±ä¹‹ç‚ºæ–‡å±±æºªæˆ–çŸ³ç¢‡æºªï¼Œæ˜¯æ°´æºä¿è­·å€çš„é‡è¦æ°´è„ˆã€‚' },
                        { q: '2-2. ä»¥å‰çš„æ¡ç¤¦æ´»å‹•å¯èƒ½æœƒç•™ä¸‹ä¸€äº›ç’°å¢ƒç—•è·¡ï¼Œä¸‹åˆ—å“ªä¸€å€‹ã€Œä¸æ˜¯ã€ç¤¦å€å¸¸è¦‹çš„å•é¡Œï¼Ÿ', options: ['A. å»¢ç¤¦å †ç”¢ç”Ÿçš„é…¸æ€§æ°´ã€‚', 'B. é‡é‡‘å±¬æ®˜ç•™ã€‚', 'C. æºªæ°´è®Šæˆæº«æ³‰ã€‚', 'D. æ³¥æ²™æ·¤ç©ã€‚'], answer: 'C', sdg: 'sdg-15', sdgText: 'SDG 15 é™¸åŸŸç”Ÿæ…‹', explanation: 'ç…¤ç¤¦é–‹æ¡ä¸¦ä¸æœƒè®“æºªæ°´è®Šæˆæº«æ³‰å–”ï¼ä¸»è¦å•é¡Œæ˜¯å»¢ç¤¦å †æ¥è§¸ç©ºæ°£é›¨æ°´å¾Œç”¢ç”Ÿçš„åŒ–å­¸åæ‡‰ã€‚' },
                        { q: '2-3. å¦‚æœä½ åœ¨æºªè£¡çœ‹åˆ°å¾ˆå¤šã€Œè‹¦èŠ±é­šã€åœ¨é–ƒé–ƒç™¼å…‰ï¼Œé€™ä»£è¡¨é€™è£¡çš„æ°´è³ªå¦‚ä½•ï¼Ÿ', options: ['A. æ°´è³ªå¾ˆé«’ã€‚', 'B. é€™è£¡æœ‰äººåœ¨é¤Šé­šã€‚', 'C. æ°´è³ªæ¸…æ¾ˆã€å«æ°§é‡é«˜ï¼Œç”Ÿæ…‹å¾ˆæ£’ã€‚', 'D. æºªæµå¿«è¦ä¹¾æ¯äº†ã€‚'], answer: 'C', sdg: 'sdg-15', sdgText: 'SDG 15 ç”Ÿç‰©å¤šæ¨£æ€§', explanation: 'è‹¦èŠ±é­šï¼ˆéŸé œé­šï¼‰å°æ°´è³ªè¦æ±‚å¾ˆé«˜ï¼Œåªæ£²æ¯åœ¨ä½æº«ã€é«˜æº¶æ°§çš„æ¸…æ¾ˆæºªæµä¸­ï¼Œæ˜¯è‰¯å¥½çš„ç’°å¢ƒæŒ‡æ¨™ã€‚' },
                        { q: '2-4. ä¾†çŸ³ç¢‡ç©çš„æ™‚å€™ï¼Œæ€éº¼åšæ‰æ˜¯æ„›è­·æºªæµçš„å¥½æ—…äººï¼Ÿ', options: ['A. æŠŠåƒå‰©çš„é£Ÿç‰©ä¸Ÿçµ¦é­šåƒã€‚', 'B. ä½¿ç”¨ç’°ä¿é˜²æ›¬ä¹³ï¼Œåƒåœ¾è‡ªå·±å¸¶èµ°ã€‚', 'C. éš¨ä¾¿æ¬å‹•çŸ³é ­æŠ“è¦å­ã€‚', 'D. åœ¨æºªé‚Šæ´—ç¢—ã€‚'], answer: 'B', sdg: 'sdg-6', sdgText: 'SDG 6 æ°´è³‡æºä¿è­·', explanation: 'æ„›å®ƒå°±ä¸è¦å‚·å®³å®ƒã€‚ç„¡ç—•å±±æ—ï¼ˆLNTï¼‰åŸå‰‡å¼·èª¿æŠŠè‡ªå·±å¸¶ä¾†çš„æ±è¥¿å¸¶èµ°ï¼Œä¸ç•™ç—•è·¡ã€‚' }
                    ]
                },
                {
                    id: 2, title: 'ç¬¬ä¸‰ç«™ï¼šå±±åŸçš„å»ºç¯‰æ™ºæ…§ (èšè½å‰µç”Ÿ)', fragment: 'ã€å»ºç¯‰æ‹¼åœ–ã€‘',
                    questions: [
                        { q: '3-1. çŸ³ç¢‡æ±è¡—æœ‰ä¸€ç¨®å¾ˆç‰¹åˆ¥çš„å»ºç¯‰å«ã€ŒåŠè…³æ¨“ã€ï¼Œæˆ¿å­æ‡¸ç©ºåœ¨æºªåºŠä¸Šï¼ŒåŸå› æ˜¯ï¼Ÿ', options: ['A. ç‚ºäº†å¥½çœ‹ã€‚', 'B. å¹³åœ°å¤ªå°‘ï¼Œç‚ºäº†çˆ­å–ç©ºé–“çš„ç”Ÿå­˜æ™ºæ…§ã€‚', 'C. ç‚ºäº†é˜²ç¦¦æ•µäººã€‚', 'D. æ¨¡ä»¿åœ‹å¤–çš„è¨­è¨ˆã€‚'], answer: 'B', sdg: 'sdg-11', sdgText: 'SDG 11 å±…ä½ç’°å¢ƒ', explanation: 'çŸ³ç¢‡ä½æ–¼æºªè°·ï¼Œè…¹åœ°æ¥µå°ã€‚å±…æ°‘åˆ©ç”¨æŸ±å­å°‡æˆ¿å±‹æ‡¸ç©ºæ”¯æ’åœ¨æ²³åºŠä¸Šï¼Œå±•ç¾äº†èˆ‡è‡ªç„¶å…±å­˜çš„æ™ºæ…§ã€‚' },
                        { q: '3-2. èµ°åœ¨çŸ³ç¢‡è€è¡—ï¼Œä½ æœƒç™¼ç¾é ­é ‚æœ‰é®è”½ï¼Œåƒèµ°åœ¨å®¤å…§ä¸€æ¨£ï¼Œé€™å°±æ˜¯è‘—åçš„ã€Œä¸è¦‹å¤©è¡—ã€ã€‚å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼Ÿ', options: ['A. è®“å¤§å®¶åšç”Ÿæ„ä¸æ€•ä¸‹é›¨ã€‚', 'B. ç‚ºäº†é˜²æ›¬ã€‚', 'C. å¢åŠ æˆ¿å­é‡é‡ã€‚', 'D. ç¨®æ¤ç‰©ç”¨çš„ã€‚'], answer: 'A', sdg: 'sdg-11', sdgText: 'SDG 11 æ°£å€™é©æ‡‰', explanation: 'å±±å€å¤šé›¨ï¼Œã€Œä¸è¦‹å¤©ã€çš„è¨­è¨ˆè®“å•†æ¥­æ´»å‹•ä¸å—å¤©æ°£å½±éŸ¿ï¼Œå½¢æˆäº†å°ç£å°‘è¦‹çš„ç‰¹æ®Šæ™¯è§€ã€‚' },
                        { q: '3-3. è¨±å¤šå¹´è¼•äººå›åˆ°çŸ³ç¢‡æ¨å‹•ã€Œåœ°æ–¹å‰µç”Ÿã€ï¼Œä¸‹åˆ—å“ªå€‹åšæ³•æœ€èƒ½æ°¸çºŒç™¼å±•ï¼Ÿ', options: ['A. çµåˆåœ¨åœ°èŒ¶è‘‰ã€æ¡‚èŠ±åšå‰µæ„å•†å“ã€‚', 'B. åŸ¹è¨“é•·è¼©èªªæ•…äº‹å°è¦½ã€‚', 'C. å¼•é€²è·Ÿç•¶åœ°ç„¡é—œçš„å¤§å‹éŠæ¨‚å ´ã€‚', 'D. ä¿®å¾©è€å±‹è®Šæˆè—æ–‡ç©ºé–“ã€‚'], answer: 'C', sdg: 'sdg-8', sdgText: 'SDG 8 åœ°æ–¹å‰µç”Ÿ', explanation: 'åœ°æ–¹å‰µç”Ÿå¼·èª¿æŒ–æ˜ã€Œåœ¨åœ°ç‰¹è‰²ã€ã€‚èˆ‡ç•¶åœ°æ–‡åŒ–è„«ç¯€çš„å¤§å‹è¨­æ–½ï¼Œå¾€å¾€ç„¡æ³•å¸¶ä¾†é•·ä¹…çš„å¹¸ç¦æ„Ÿã€‚' },
                        { q: '3-4. æƒ³è¦çœŸæ­£æ„Ÿå—çŸ³ç¢‡çš„é­…åŠ›ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ï¼Ÿ', options: ['A. æ‹å®Œç…§å°±èµ°ã€‚', 'B. æ…¢ä¸‹ä¾†ï¼Œèµ°é€²å··å¼„è·Ÿå±…æ°‘èŠèŠå¤©ã€‚', 'C. èº²åœ¨å†·æ°£æˆ¿è£¡ã€‚', 'D. æŠ±æ€¨é€™è£¡æ²’è¶…å•†ã€‚'], answer: 'B', sdg: 'sdg-4', sdgText: 'SDG 4 çµ‚èº«å­¸ç¿’', explanation: 'æœ€ç¾çš„é¢¨æ™¯æ˜¯äººã€‚é€éå°è©±èˆ‡æ·±åº¦æ¼«éŠï¼Œæ‰èƒ½çœŸæ­£æ„Ÿå—åˆ°å±±åŸçš„ç”Ÿæ´»æº«åº¦ã€‚' }
                    ]
                },
                {
                    id: 3, title: 'ç¬¬å››ç«™ï¼šå‡ºç™¼å‰çš„ç´„å®š (è¡Œå‰ç¢ºèª)', fragment: 'ã€å…Œæ›ä¿¡ç‰©ã€‘',
                    questions: [
                        { q: '4-1. ã€åœ°æ¨™ç¢ºèªã€‘è¦å»ã€Œä¸è¦‹å¤©è¡—ã€æ‰¾ç¦®ç‰©ï¼Œä½ è¦èªå¾—å“ªç¨®å»ºç¯‰ç‰¹è‰²æ‰ä¸æœƒè¿·è·¯ï¼Ÿ', options: ['A. åˆ°è™•éƒ½æ˜¯æ‘©å¤©å¤§æ¨“ã€‚', 'B. è¡—é“ä¸Šæ–¹è¢«å»ºç¯‰è¦†è“‹ï¼Œçœ‹ä¸åˆ°å¤©ç©ºã€‚', 'C. é‡‘å­—å¡”ã€‚', 'D. æµ·åº•éš§é“ã€‚'], answer: 'B', sdg: 'sdg-11', sdgText: 'SDG 11 è§€å¯Ÿ', explanation: 'æ²’éŒ¯ï¼èªæ˜ã€Œçœ‹ä¸è¦‹å¤©ç©ºã€çš„è¡—é“ï¼Œå°±æ˜¯é€šå¾€é©šå–œçš„å…¥å£ï¼' },
                        { q: '4-2. ã€æ…‹åº¦ç¢ºèªã€‘ç•¶ä½ é‡åˆ°çŸ³ç¢‡çš„è²“å’ªæˆ–å±…æ°‘æ™‚ï¼Œä»€éº¼æ¨£çš„æ…‹åº¦æœ€å—æ­¡è¿ï¼Ÿ', options: ['A. å¤§è²å–§å˜©ã€‚', 'B. äº‚ä¸Ÿåƒåœ¾ã€‚', 'C. è¼•è²ç´°èªï¼Œä¿æŒå¾®ç¬‘èˆ‡å°Šé‡ã€‚', 'D. éš¨ä¾¿äº‚æ‘¸ã€‚'], answer: 'C', sdg: 'sdg-4', sdgText: 'SDG 4 å°Šé‡', explanation: 'å°Šé‡æ˜¯æœ€å¥½çš„é€šè¡Œè­‰ã€‚å‹å–„çš„æ—…äººï¼Œæ‰èƒ½çœ‹è¦‹æœ€ç¾çš„é¢¨æ™¯ã€‚' },
                        { q: '4-3. ã€æœ€çµ‚ç¢ºèªã€‘ä½ å·²ç¶“æ‹¿åˆ°æ‰€æœ‰çš„ç·šç´¢äº†ï¼è«‹å•ä¸‹ä¸€æ­¥è©²æ€éº¼åšï¼Ÿ', options: ['A. é—œæ‰æ‰‹æ©Ÿå»ç¡è¦ºã€‚', 'B. æˆªåœ–ä¿å­˜å…Œæ›åˆ¸ï¼Œè¦ªè‡ªå»çŸ³ç¢‡èµ°èµ°ï¼', 'C. æŠŠå®ƒåˆªæ‰ã€‚', 'D. è¦ºå¾—ç„¡èŠã€‚'], answer: 'B', sdg: 'sdg-17', sdgText: 'SDG 17 å¯¦è¸', explanation: 'å¤ªæ£’äº†ï¼è²“å’ªå€‘å·²ç¶“æº–å‚™å¥½ç¦®ç‰©ï¼ŒæœŸå¾…åœ¨çŸ³ç¢‡èˆ‡ä½ ç›¸è¦‹ï¼' }
                    ]
                }
            ]
        };

        let gameState = {
            currentStage: 0,
            currentQuestion: 0,
            fragmentsCollected: 0,
            score: 0,
            abilitiesUsed: { 0: false, 1: false, 2: false, 3: false },
            isQuestionLocked: false,
            selectedPartnerKey: null,
            answers: {},
            isTransitioning: false 
        };

        const elements = {
            screens: document.querySelectorAll('.screen'),
            stageTitle: document.getElementById('stage-title'),
            progressText: document.getElementById('progress-text'),
            questionText: document.getElementById('question-text'),
            optionsList: document.getElementById('options-list'),
            explanationArea: document.getElementById('explanation-area'),
            explanationText: document.getElementById('explanation-text'),
            abilityUI: document.getElementById('ability-ui'),
            currentAbility: document.getElementById('current-ability'),
            message: document.getElementById('message'),
            nextQBtn: document.getElementById('next-q-btn'),
            prevQBtn: document.getElementById('prev-q-btn'),
            partnerInfoText: document.getElementById('partner-info-text'),
            roleSelectionGrid: document.getElementById('role-selection-grid'),
            confirmRoleBtn: document.getElementById('confirm-role-btn'),
            gameCharacterDisplay: document.getElementById('game-character-display'),
            finalPartnerName: document.getElementById('final-partner-name'),
            victoryOverlay: document.getElementById('victory-overlay') 
        };

        window.history.replaceState({ page: 'start-screen' }, '', '');

        window.addEventListener('popstate', (event) => {
            if (event.state) {
                handleStateChange(event.state);
            } else {
                showScreen('start-screen');
            }
        });

        function handleStateChange(state) {
            if (state.page === 'game-screen') {
                gameState.currentStage = state.stage;
                gameState.currentQuestion = state.question;
                showScreen('game-screen');
                displayCharacterImage();
                renderGame(false); 
            } else {
                showScreen(state.page);
                if(state.page === 'select-role-screen') {
                    renderRoleSelection();
                }
            }
        }

        function showScreen(screenId) {
            elements.screens.forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            elements.gameCharacterDisplay.style.display = (screenId === 'game-screen') ? 'block' : 'none';
            window.scrollTo(0, 0); 
        }

        function goToRoleSelection() {
            history.pushState({ page: 'select-role-screen' }, '', '');
            showScreen('select-role-screen');
            renderRoleSelection();
        }

        function renderRoleSelection() {
            elements.roleSelectionGrid.innerHTML = '';
            
            Object.values(gameData.partners).forEach(partner => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.dataset.key = partner.key; 
                card.innerHTML = `
                    <div class="role-card-image">
                        <img src="assets/${partner.imgBase}.png" alt="${partner.name}" onerror="this.style.display='none';this.parentNode.style.backgroundColor='#555';">
                    </div>
                    <div class="role-card-content">
                        <h3>${partner.name}</h3>
                        <p style="color: #bbb; font-size: 0.85em; margin-bottom: 8px;">${partner.desc}</p>
                        <p><strong>æ”¯æ´èƒ½åŠ›ï¼š</strong>${partner.ability}</p>
                    </div>
                `;
                card.onclick = (e) => {
                    document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    elements.confirmRoleBtn.classList.remove('disabled');
                };
                elements.roleSelectionGrid.appendChild(card);
            });
        }

        function confirmRoleSelection() {
            const selectedCard = document.querySelector('.role-card.selected');
            if (selectedCard) {
                gameState.selectedPartnerKey = selectedCard.dataset.key; 
                startGame();
            }
        }

        function startGame() {
            gameState.currentStage = 0;
            gameState.currentQuestion = 0;
            gameState.fragmentsCollected = 0;
            gameState.score = 0;
            gameState.abilitiesUsed = { 0: false, 1: false, 2: false, 3: false };
            gameState.answers = {}; 
            gameState.isTransitioning = false;
            
            history.pushState({ page: 'game-screen', stage: 0, question: 0 }, '', '');
            
            showScreen('game-screen');
            displayCharacterImage(); 
            renderGame(false); 
        }

        function displayCharacterImage(isSmile = false) {
            const partner = gameData.partners[gameState.selectedPartnerKey];
            const baseName = partner.imgBase; 
            const fileName = isSmile ? `${baseName}_smile.png` : `${baseName}.png`;
            
            elements.gameCharacterDisplay.innerHTML = `<img src="assets/${fileName}" alt="å¤¥ä¼´ç«‹ç¹ª" onerror="this.style.display='none'">`;
        }

        function renderGame(pushHistory = true) {
            displayCharacterImage(false);

            if (gameState.currentStage >= gameData.stages.length) {
                return showFinalScreen();
            }

            if (pushHistory) {
                history.pushState({ 
                    page: 'game-screen', 
                    stage: gameState.currentStage, 
                    question: gameState.currentQuestion 
                }, '', '');
            }

            const stage = gameData.stages[gameState.currentStage];
            const currentQ = stage.questions[gameState.currentQuestion];
            const partner = gameData.partners[gameState.selectedPartnerKey];
            const answerKey = `${gameState.currentStage}-${gameState.currentQuestion}`;
            const recordedAnswer = gameState.answers[answerKey];

            elements.stageTitle.innerText = `${stage.title}`;
            elements.partnerInfoText.innerHTML = `ä½ çš„å–µå¤¥ä¼´ï¼š<strong>${partner.name.split(' ')[0]}</strong>`;
            
            let collectionStatus = "";
            if (gameState.fragmentsCollected >= 3) {
                 collectionStatus = "âœ¨ æ‹¼åœ–å®Œæˆï¼Œæº–å‚™é ˜å–ç¦®ç‰© âœ¨";
            } else {
                 collectionStatus = `å·²æ”¶é›† ${gameState.fragmentsCollected} / 3 æ‹¼åœ–`;
            }
            elements.progressText.innerText = `${collectionStatus} | é—œå¡ ${gameState.currentStage + 1} - é¡Œ ${gameState.currentQuestion + 1}/${stage.questions.length}`;

            let sdgHtml = '';
            if (currentQ.sdg) {
                sdgHtml = `<span class="sdg-tag ${currentQ.sdg}">${currentQ.sdgText}</span><br>`;
            }
            elements.questionText.innerHTML = sdgHtml + currentQ.q; 
            
            elements.message.innerText = '';
            elements.message.style.backgroundColor = 'transparent';
            elements.explanationArea.style.display = 'none'; 
            elements.nextQBtn.classList.add('disabled');
            elements.nextQBtn.innerText = "ç¹¼çºŒå‰é€² Â»";
            
            elements.nextQBtn.classList.remove('processing'); 

            if (gameState.currentQuestion === 0 && gameState.currentStage === 0) {
                 elements.prevQBtn.classList.remove('disabled'); 
                 elements.prevQBtn.innerHTML = "&laquo; å›é¸è§’";
            } else {
                 elements.prevQBtn.classList.remove('disabled');
                 elements.prevQBtn.innerHTML = "&laquo; ä¸Šä¸€é¡Œ";
            }

            if (recordedAnswer) {
                gameState.isQuestionLocked = true;
                elements.nextQBtn.classList.remove('disabled'); 
                
                elements.explanationText.innerText = currentQ.explanation;
                elements.explanationArea.style.display = 'block';

                const isCorrect = (recordedAnswer === currentQ.answer);
                if (isCorrect) {
                    elements.message.innerText = 'âœ… (å·²ä½œç­”) ç­”å°äº†ï¼';
                    elements.message.style.backgroundColor = 'rgba(212, 237, 218, 0.9)';
                    elements.message.style.color = '#155724';
                    displayCharacterImage(true); 
                } else {
                    elements.message.innerText = `âŒ (å·²ä½œç­”) å–µå—š...æ­£ç¢ºæ˜¯ ${currentQ.answer}ã€‚`;
                    elements.message.style.backgroundColor = 'rgba(248, 215, 218, 0.9)';
                    elements.message.style.color = '#721c24';
                }
            } else {
                gameState.isQuestionLocked = false;
            }

            renderOptions(currentQ, recordedAnswer);
            renderAbilityUI(stage, currentQ, partner);
            
            // æ¯æ¬¡æ¸²æŸ“æ–°é¡Œç›®éƒ½æ»¾å‹•åˆ°é ‚éƒ¨
            if (!recordedAnswer) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function renderOptions(question, recordedAnswer) {
            elements.optionsList.innerHTML = '';
            question.options.forEach(option => {
                const li = document.createElement('li');
                li.innerText = option;
                li.onclick = () => checkAnswer(option.charAt(0), li);
                
                if (recordedAnswer) {
                    li.classList.add('disabled');
                    if (option.charAt(0) === question.answer) {
                        li.classList.add('correct-answer');
                    } else if (option.charAt(0) === recordedAnswer && recordedAnswer !== question.answer) {
                        li.classList.add('wrong-answer');
                    }
                }
                elements.optionsList.appendChild(li);
            });
        }

        function renderAbilityUI(stage, currentQ, partner) {
            const abilityBtn = elements.abilityUI.querySelector('.ability-btn');
            const questionId = currentQ.q.split('.')[0]; 
            const isSpecialtyQ = partner.specialtyQ.includes(questionId);
            elements.currentAbility.innerText = partner.ability;

            if (gameState.abilitiesUsed[stage.id]) {
                abilityBtn.innerText = 'æœ¬é—œè²“å’ªå·²å¹«å¿™é';
                abilityBtn.classList.add('disabled');
            } else if (isSpecialtyQ) {
                abilityBtn.innerText = `å‘¼å« ${partner.name.split(' ')[0]} å¹«å¿™`;
                if (!gameState.isQuestionLocked) {
                    abilityBtn.classList.remove('disabled');
                } else {
                    abilityBtn.classList.add('disabled');
                }
            } else {
                abilityBtn.innerText = 'æ­¤é¡Œéè²“å’ªç†Ÿæ‚‰é ˜åŸŸ';
                abilityBtn.classList.add('disabled');
            }
        }

        function useAbility() {
            const stage = gameData.stages[gameState.currentStage];
            const partner = gameData.partners[gameState.selectedPartnerKey];
            const currentQ = stage.questions[gameState.currentQuestion];
            const questionId = currentQ.q.split('.')[0];

            if (gameState.abilitiesUsed[stage.id] || gameState.isQuestionLocked || !partner.specialtyQ.includes(questionId)) return;

            const correctOptChar = currentQ.answer;
            const optionElements = Array.from(elements.optionsList.children);
            let wrongOptions = optionElements.filter(el => el.innerText.charAt(0) !== correctOptChar);
            
            for (let i = 0; i < 2 && wrongOptions.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * wrongOptions.length);
                wrongOptions[randomIndex].style.visibility = 'hidden'; 
                wrongOptions[randomIndex].classList.add('disabled'); 
                wrongOptions.splice(randomIndex, 1);
            }

            gameState.abilitiesUsed[stage.id] = true;
            renderAbilityUI(stage, currentQ, partner);
            elements.message.innerText = `ğŸ’¡ ${partner.name.split(' ')[0]} ä¼¸å‡ºäº†è²“æŒï¼Œå¹«ä½ æ’¥é–‹äº†å¹²æ“¾é¸é …ï¼`;
            elements.message.style.backgroundColor = 'rgba(255, 255, 204, 0.9)';
            elements.message.style.color = '#333';
        }

        function checkAnswer(selectedOptionChar, liElement) {
            if (gameState.isQuestionLocked || liElement.classList.contains('disabled')) return;

            const currentQ = gameData.stages[gameState.currentStage].questions[gameState.currentQuestion];
            const isCorrect = (selectedOptionChar === currentQ.answer);

            const answerKey = `${gameState.currentStage}-${gameState.currentQuestion}`;
            gameState.answers[answerKey] = selectedOptionChar;

            gameState.isQuestionLocked = true;
            elements.nextQBtn.classList.remove('disabled');

            // é¡¯ç¤ºè©³è§£
            elements.explanationText.innerText = currentQ.explanation;
            elements.explanationArea.style.display = 'block';
            
            // è‡ªå‹•æ»¾å‹•åˆ°è©³è§£å€åŸŸ (UXå„ªåŒ–)
            setTimeout(() => {
                elements.explanationArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);

            Array.from(elements.optionsList.children).forEach(item => {
                item.classList.add('disabled');
                if (item.innerText.charAt(0) === currentQ.answer) {
                    item.classList.add('correct-answer');
                } else if (item === liElement && !isCorrect) {
                    item.classList.add('wrong-answer');
                }
            });

            if (isCorrect) {
                gameState.score++;
                displayCharacterImage(true); 
                
                const randomMsg = feedbackMessages.correct[Math.floor(Math.random() * feedbackMessages.correct.length)];
                elements.message.innerText = randomMsg;
                elements.message.style.backgroundColor = 'rgba(212, 237, 218, 0.9)';
                elements.message.style.color = '#155724';
            } else {
                const randomMsg = feedbackMessages.wrong[Math.floor(Math.random() * feedbackMessages.wrong.length)];
                elements.message.innerText = `${randomMsg}${currentQ.answer}ã€‚`;
                elements.message.style.backgroundColor = 'rgba(248, 215, 218, 0.9)';
                elements.message.style.color = '#721c24';
            }
        }

        function nextQuestion() {
            if (!gameState.isQuestionLocked || gameState.isTransitioning) return;

            elements.nextQBtn.classList.add('processing', 'disabled');
            gameState.isTransitioning = true; 

            gameState.currentQuestion++;
            const stage = gameData.stages[gameState.currentStage];

            if (gameState.currentQuestion >= stage.questions.length) {
                gameState.fragmentsCollected++;
                
                let transitionMsg = `ğŸ‰ é—œå¡å®Œæˆï¼ç²å¾—${stage.fragment}ã€‚æº–å‚™å‰å¾€ä¸‹ä¸€ç«™...`;
                if (gameState.currentStage === 2) { 
                    transitionMsg = `ğŸ‰ æ‹¼åœ–æ”¶é›†å®Œæˆï¼é€²å…¥æœ€å¾Œç¢ºèª...`;
                }

                elements.message.innerText = transitionMsg;
                elements.message.style.backgroundColor = 'rgba(255, 183, 77, 0.9)';
                elements.nextQBtn.innerText = "é€²å…¥ä¸‹ä¸€éšæ®µ Â»";
                
                setTimeout(() => {
                    gameState.currentStage++;
                    gameState.currentQuestion = 0;
                    gameState.isTransitioning = false; 
                    renderGame(); 
                }, 2000);
            } else {
                gameState.isTransitioning = false;
                renderGame(); 
            }
        }
        
        function showFinalScreen() {
            elements.victoryOverlay.style.display = 'flex'; 
            elements.victoryOverlay.classList.remove('fade-out');
            elements.victoryOverlay.classList.add('fade-in');

            elements.finalPartnerName.innerText = gameData.partners[gameState.selectedPartnerKey].name.split(' ')[0];
            const today = new Date();
            const dateStr = `${today.getMonth()+1}${today.getDate()}`;
            const randomCode = Math.floor(Math.random() * 9000) + 1000;
            document.getElementById('coupon-code-text').innerText = `SD-${dateStr}-${randomCode}`;

            setTimeout(() => {
                elements.victoryOverlay.classList.remove('fade-in');
                elements.victoryOverlay.classList.add('fade-out');
                
                setTimeout(() => {
                    elements.victoryOverlay.style.display = 'none'; 
                    history.pushState({ page: 'final-screen' }, '', '');
                    showScreen('final-screen');
                }, 500); 
            }, 3000);
        }

        showScreen('start-screen');

    </script>
</body>
</html>
